<ng-container *ngIf="(board$ | async) as board">
  <ng-container *ngIf="(filter$ | async) as f">
    <div class="kanban-wrapper">
      <header class="kb-header" role="banner">
        <div class="kb-row top">
          <div class="kb-title-group">
            <h1>{{ board.title }}</h1>
            <div class="board-meta" *ngIf="(columns$ | async) as columns" aria-label="Board stats">{{ columns.length }} columns • {{ cardCount(columns) }} tasks</div>
          </div>
          <div class="quick-add" role="form" aria-label="Quick add task">
            <input #quickAdd placeholder="Quick add task" (keyup.enter)="quickAdd.value.trim() && addQuick(quickAdd.value); quickAdd.value=''" />
            <button type="button" (click)="quickAdd.value.trim() && addQuick(quickAdd.value); quickAdd.value=''" title="Add task">Add</button>
          </div>
        </div>
        <div class="kb-row filters" role="toolbar" aria-label="Board filters">
          <div class="group search-group">
            <label class="visually-hidden" for="board-search">Search</label>
            <input id="board-search" #search placeholder="Search tasks" [value]="f.text" (input)="setText(search.value)" aria-label="Search tasks" />
            <button type="button" *ngIf="f.text" class="clear" (click)="setText(''); search.value=''" aria-label="Clear search">✕</button>
          </div>
          <div class="group pills" aria-label="Priority filter">
            <button type="button" class="pill" [class.active]="(f.priority||'any')==='any'" (click)="setPriority('any')">All</button>
            <button type="button" class="pill" [class.active]="f.priority==='high'" (click)="setPriority('high')"><span class="dot" style="background:var(--color-danger)"></span>High</button>
            <button type="button" class="pill" [class.active]="f.priority==='medium'" (click)="setPriority('medium')"><span class="dot" style="background:var(--color-warn)"></span>Med</button>
            <button type="button" class="pill" [class.active]="f.priority==='low'" (click)="setPriority('low')"><span class="dot" style="background:var(--color-success)"></span>Low</button>
          </div>
          <div class="group due" aria-label="Due date filter">
            <input #date type="date" [value]="f.due || ''" (change)="setDue(date.value)" aria-label="Due date filter" />
            <button type="button" *ngIf="f.due" class="clear" (click)="setDue(''); date.value=''" aria-label="Clear due date">✕</button>
          </div>
          <div class="group actions">
            <button type="button" (click)="addColumn()" title="Add column" class="pill add-col">+ Column</button>
            <button type="button" class="pill warn" *ngIf="(lastDeleted$ | async) as ld" (click)="undo()" title="Undo deletion">Undo “{{ ld.card.title }}”</button>
            <button type="button" class="pill" (click)="toggleShowCompleted()" [class.active]="showCompleted()" title="Toggle completed visibility">{{ showCompleted() ? 'Hide' : 'Show' }} Done</button>
          </div>
        </div>
      </header>
      <div class="kb-status" *ngIf="!(columns$ | async); else colsLoaded" aria-live="polite">Loading board…</div>
      <ng-template #colsLoaded>
        <div class="kb-empty-board" *ngIf="(columns$ | async) as columns">
          <ng-container *ngIf="columns.length; else noColumns">
            <div class="kb-columns" role="list" aria-label="Board columns">
              <app-kanban-column *ngFor="let col of columns; trackBy: trackCol"
                [column]="col"
                [collapsed]="isCollapsed(col.id)"
                [connectedTo]="connectedTo(columns, col.id)"
                [highlight]="f.text"
                [cards]="filteredCards((cards(col.id) | async) || [])"
                (add)="addCard(col.id)"
                (rename)="renameColumn(col.id)"
                (delete)="deleteColumn(col.id)"
                (updateCard)="updateCard($event.id, $event.changes)"
                (toggleCard)="toggleCard($event)"
                (open)="open($event)"
                (dropCard)="drop($event, col.id, col.id)"
                (sort)="setSort(col.id, $event)"
                (collapse)="toggleColumnCollapse(col.id)"></app-kanban-column>
            </div>
            <ng-container *ngIf="cardCount(columns) === 0">
              <div class="kb-hint" aria-live="polite">No tasks yet. Add a card to get started.</div>
            </ng-container>
          </ng-container>
          <ng-template #noColumns>
            <div class="kb-hint" aria-live="polite">No columns yet. Create your first column.</div>
          </ng-template>
        </div>
      </ng-template>
      <app-card-detail></app-card-detail>
    </div>
  </ng-container>
</ng-container>
